
def time_out(outlets, performancelogger, time_step_simulation):
    for outlet_index, outlet in enumerate(outlets):
        if outlet.__class__.__name__ == 'Wifi':
            services_timed_out = []
            for i, (service, flag) in enumerate(performancelogger.queue_waiting_requests_in_buffer[outlet]):
                if flag == True:
                    start_time = performancelogger.queue_time_out_buffer[outlet][service][0]
                    time_out = performancelogger.queue_time_out_buffer[outlet][service][1]
                    if start_time + time_out <= time_step_simulation and len(
                            performancelogger.queue_waiting_requests_in_buffer[outlet]) > 0:
                        services_timed_out.append(service)
                        outlet.dqn.environment.state.remaining_time_out = 0
                        outlet.dqn.environment.state.waiting_buffer_len = len(
                            performancelogger.queue_waiting_requests_in_buffer[outlet]) - len(services_timed_out)
                        outlet.dqn.environment.state.timed_out_length =  len(services_timed_out)
            for ser in services_timed_out:
                performancelogger.queue_waiting_requests_in_buffer[outlet].remove([ser, True])
                # performancelogger.queue_ensured_buffer[outlet].popleft()
                # performancelogger.queue_requested_buffer[outlet].popleft()

def from_wait_to_serve(outlets, performancelogger, time_step_simulation):
    for outlet_index, outlet in enumerate(outlets):
        if outlet.__class__.__name__ == 'Wifi':
            service_moved_to_served = []
            for i, (service, flag) in enumerate(performancelogger.queue_waiting_requests_in_buffer[outlet]):
                if flag == True:
                    start_time = performancelogger.queue_time_out_buffer[outlet][service][0]
                    time_out = performancelogger.queue_time_out_buffer[outlet][service][1]
                    if start_time + time_out > time_step_simulation and outlet.current_capacity >= service.service_power_allocate and len(
                            performancelogger.queue_waiting_requests_in_buffer[outlet]) > 0:

                        service_moved_to_served.append(service)
                        if [service, False] in performancelogger.queue_power_for_requested_in_buffer[outlet]:
                            index = performancelogger.queue_power_for_requested_in_buffer[outlet].index(
                                [service, False])
                            performancelogger.queue_power_for_requested_in_buffer[outlet][index][1] = True
                            # print("moved from wait to serv")
                            # print("the index ...................... ",index)

                        performancelogger.queue_provisioning_time_buffer[outlet][service] = [start_time,
                                                                                             service.calcualate_processing_time()]
                        performancelogger.queue_ensured_buffer[outlet].appendleft(1)
                        outlet.dqn.environment.reward.services_requested = len(
                            performancelogger.queue_requested_buffer[outlet])
                        outlet.dqn.environment.reward.services_ensured = len(
                            performancelogger.queue_ensured_buffer[outlet])



                        outlet.current_capacity = outlet.current_capacity - service.service_power_allocate
                        outlet.dqn.environment.state._tower_capacity = outlet.current_capacity

                        outlet.dqn.environment.state.waiting_buffer_len = len(
                            performancelogger.queue_waiting_requests_in_buffer[outlet]) - len( service_moved_to_served)

                        outlet.dqn.environment.state.from_waiting_to_serv_length =  len(service_moved_to_served)
            for ser in service_moved_to_served:
                performancelogger.queue_waiting_requests_in_buffer[outlet].remove([ser, True])
                # print("removed2 : ", len(performancelogger.queue_waiting_requests_in_buffer[outlet]))
